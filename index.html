<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Firebase ì»¤ë®¤ë‹ˆí‹° â€” ì‹¤ì‹œê°„ ê³µìœ </title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f6f8fb;--panel:#ffffff;--text:#222;--muted:#8a94a6;
      --primary:#6c63ff;--accent:#ff6584;--radius:14px;
    }
    [data-theme="dark"]{
      --bg:#171826;--panel:#232439;--text:#f5f5f7;--muted:#a8aec0;
      --primary:#7c76ff;--accent:#ff6a8a;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;
      background:var(--bg);color:var(--text);transition:background .25s,color .25s}
    header{position:sticky;top:0;z-index:40;background:var(--panel);box-shadow:0 2px 10px rgba(0,0,0,.08);
      padding:12px 18px;display:flex;gap:12px;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--primary),var(--accent))}
    h1{font-size:18px;margin:0}
    .header-right{display:flex;align-items:center;gap:10px}
    .btn{border:none;border-radius:12px;padding:8px 12px;font-size:13px;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff}
    .btn.ghost{background:transparent;border:1px solid #d6d6e7;color:var(--text)}
    .user-chip{display:flex;align-items:center;gap:8px;background:rgba(108,99,255,.12);color:var(--primary);border-radius:999px;padding:6px 10px}
    .avatar-chip{width:22px;height:22px;border-radius:50%;background:#c7c7d7;background-size:cover;background-position:center}
    .layout{display:grid;grid-template-columns:220px 1fr 280px;gap:18px;max-width:1200px;margin:18px auto;padding:0 18px}
    .panel{background:var(--panel);border-radius:var(--radius);box-shadow:0 2px 8px rgba(0,0,0,.06);padding:18px}
    textarea,input[type="text"],input[type="password"],input[type="email"]{width:100%;padding:12px;border:1px solid #d6d6e7;border-radius:12px;background:transparent;color:var(--text)}
    .post{border:1px solid rgba(0,0,0,.06);border-radius:14px;padding:14px;margin-top:14px}
    .post-head{display:flex;align-items:center;gap:10px;margin-bottom:6px}
    .meta{color:var(--muted);font-size:12px}
    .actions{display:flex;gap:10px;margin-top:10px}
    .action{border:none;background:transparent;color:var(--primary);cursor:pointer}
    .counts{margin-top:6px;color:var(--muted);font-size:12px}
    .right h3{margin:0 0 10px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(0,0,0,.06);margin:4px 6px 0 0;font-size:12px}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:60}
    .card{width:380px;max-width:92vw}
    .chat{position:fixed;right:18px;bottom:0;width:320px;background:var(--panel);border-radius:16px 16px 0 0;box-shadow:0 -6px 18px rgba(0,0,0,.15);transform:translateY(85%);transition:transform .25s;z-index:54}
    .chat.open{transform:translateY(0)}
    .chat-head{background:var(--primary);color:#fff;padding:10px 14px;border-radius:16px 16px 0 0;cursor:pointer}
    .chat-body{padding:12px;height:220px;overflow:auto}
    .chat-input{display:flex;border-top:1px solid rgba(0,0,0,.1)}
    .chat-input input{border:none;padding:12px;flex:1}
    .chat-input button{border:none;background:var(--primary);color:#fff;padding:0 16px;cursor:pointer}
    .xp-row{display:flex;align-items:center;gap:8px}
    .bar{flex:1;height:8px;border-radius:999px;background:rgba(0,0,0,.08);overflow:hidden}
    .fill{height:100%;background:linear-gradient(90deg,var(--primary),var(--accent));width:0%}
    .badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .badge-tile{background:rgba(0,0,0,.06);padding:6px 10px;border-radius:10px;font-size:12px}
    .notice{position:fixed;left:50%;top:18px;transform:translateX(-50%);background:var(--panel);color:var(--text);
      border:1px solid rgba(0,0,0,.08);padding:10px 14px;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,.15);display:none;z-index:70}
    .post-image{margin-top:10px;border-radius:12px;max-width:100%;display:block}
    .avatar-lg{width:64px;height:64px;border-radius:50%;background:#c7c7d7;background-size:cover;background-position:center}
    .preview{margin-top:8px;font-size:12px;color:var(--muted)}
  </style>
</head>
<body data-theme="light">
  <header>
    <div class="brand">
      <div class="logo"></div><h1>Firebase ì»¤ë®¤ë‹ˆí‹°</h1>
    </div>
    <div class="header-right" id="authArea">
      <button class="btn ghost" onclick="openModal('login')">ë¡œê·¸ì¸</button>
      <button class="btn primary" onclick="openModal('signup')">íšŒì›ê°€ì…</button>
      <button class="btn ghost" onclick="toggleTheme()">ğŸŒ™/â˜€ï¸</button>
    </div>
    <div class="header-right" id="userArea" style="display:none;">
      <div class="user-chip">
        <div id="chipAvatar" class="avatar-chip"></div>
        <span id="chipNick">-</span> Â· LV <span id="chipLv">1</span>
      </div>
      <button class="btn ghost" onclick="router.show('profile')">í”„ë¡œí•„</button>
      <button class="btn primary" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
      <button class="btn ghost" onclick="toggleTheme()">ğŸŒ™/â˜€ï¸</button>
    </div>
  </header>

  <div class="layout" id="pageFeed">
    <aside class="panel">
      <ul style="list-style:none;padding:0;margin:0">
        <li style="padding:8px 0;cursor:pointer" onclick="router.show('feed')">ğŸ  í™ˆ</li>
<li style="padding:8px 0;cursor:pointer" onclick="router.show('hot')">ğŸ”¥ ì¸ê¸°ê¸€</li>
        <li style="padding:8px 0;cursor:pointer" onclick="router.show('profile')">ğŸ§‘ ë‚´ í”„ë¡œí•„</li>
      </ul>
    </aside>

    <main>
      <div class="panel">
        <h3 style="margin-top:0">ê¸€ì“°ê¸°</h3>
        <textarea id="composer" placeholder="ë¬´ìŠ¨ ìƒê°ì„ í•˜ê³  ê³„ì‹ ê°€ìš”? (ë¡œê·¸ì¸ í•„ìš”)"></textarea>
        <div style="display:flex;gap:10px;margin-top:10px;align-items:center">
          <input id="postImage" type="file" accept="image/*" />
          <button class="btn primary" onclick="addPost()">ë“±ë¡</button>
        </div>
        <div id="postImagePreview" class="preview"></div>
      </div>
      <div id="posts"></div>
    </main>

    <aside class="panel right">
      <h3>ì‹¤ì‹œê°„ íŠ¸ë Œë“œ</h3>
      <div>
        <span class="pill">#Firebase</span>
        <span class="pill">#ì‹¤ì‹œê°„</span>
        <span class="pill">#ì»¤ë®¤ë‹ˆí‹°</span>
      </div>
      <div style="margin-top:16px">
        <h3>Tips</h3>
        <div class="meta">ë¡œê·¸ì¸í•˜ë©´ ê¸€/ëŒ“ê¸€/ì¢‹ì•„ìš” ê°€ëŠ¥</div>
      </div>
    </aside>
  </div>

  <!-- PROFILE -->
  <div class="layout" id="pageProfile" style="display:none;">
    <aside class="panel">
      <ul style="list-style:none;padding:0;margin:0">
        <li style="padding:8px 0;cursor:pointer" onclick="router.show('feed')">â¬… í”¼ë“œë¡œ ëŒì•„ê°€ê¸°</li>
      </ul>
    </aside>
    <main>
      <div class="panel">
        <h3 style="margin-top:0">ë‚´ í”„ë¡œí•„</h3>
        <div style="display:flex;align-items:center;gap:14px">
          <div id="profAvatar" class="avatar-lg"></div>
          <div>
            <div style="font-weight:700;font-size:18px" id="profNick">-</div>
            <div class="meta" id="profEmail">@</div>
          </div>
        </div>
        <div style="display:flex;gap:10px;margin-top:10px;align-items:center">
          <input id="avatarInput" type="file" accept="image/*" />
          <button class="btn ghost" onclick="uploadAvatar()">í”„ë¡œí•„ ì‚¬ì§„ ì—…ë¡œë“œ</button>
        </div>
        <div style="margin-top:12px" class="xp-row">
          <strong>LV <span id="profLv">1</span></strong>
          <div class="bar"><div class="fill" id="xpFill"></div></div>
          <span id="xpText">0/100</span>
        </div>
        <div class="badges" id="badges"></div>
      </div>

      <div class="panel">
        <h3 style="margin:0 0 10px">ë‚´ê°€ ì“´ ê¸€</h3>
        <div id="myPosts"></div>
      </div>
    </main>
    <aside class="panel right"></aside>
  </div>

  <!-- ëŒ“ê¸€ ëª¨ë‹¬ -->
  <div class="modal" id="commentModal">
    <div class="panel card">
      <h3 style="margin-top:0">ëŒ“ê¸€</h3>
      <div id="commentList" style="max-height:260px;overflow:auto;margin-bottom:8px"></div>
      <input id="commentInput" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš” (ë¡œê·¸ì¸ í•„ìš”)" onkeypress="if(event.key==='Enter') addComment()" />
      <div style="display:flex;gap:8px;margin-top:10px;justify-content:flex-end">
        <button class="btn primary" onclick="addComment()">ë“±ë¡</button>
        <button class="btn ghost" onclick="closeModal()">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ë¡œê·¸ì¸/íšŒì›ê°€ì… ëª¨ë‹¬ -->
  <div class="modal" id="loginModal">
    <div class="panel card">
      <h3 style="margin-top:0">ë¡œê·¸ì¸</h3>
      <input id="loginEmail" type="email" placeholder="ì´ë©”ì¼" />
      <input id="loginPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" />
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn primary" onclick="login()">ë¡œê·¸ì¸</button>
        <button class="btn ghost" onclick="openModal('signup')">íšŒì›ê°€ì…ìœ¼ë¡œ</button>
        <button class="btn ghost" onclick="closeModal()">ë‹«ê¸°</button>
      </div>
    </div>
  </div>
  <div class="modal" id="signupModal">
    <div class="panel card">
      <h3 style="margin-top:0">íšŒì›ê°€ì…</h3>
      <input id="suEmail" type="email" placeholder="ì´ë©”ì¼" />
      <input id="suPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" />
      <input id="suNick" placeholder="ë³„ëª…(ë‹‰ë„¤ì„)" />
      <div class="meta">â€» ë‹‰ë„¤ì„ì€ í”„ë¡œí•„ì— ì €ì¥ë©ë‹ˆë‹¤.</div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn primary" onclick="signup()">ê°€ì…í•˜ê¸°</button>
        <button class="btn ghost" onclick="openModal('login')">ë¡œê·¸ì¸ìœ¼ë¡œ</button>
        <button class="btn ghost" onclick="closeModal()">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ì±„íŒ…(ë°ëª¨: ë¡œì»¬ UI) -->
  <div class="chat" id="chat">
    <div class="chat-head" onclick="toggleChat()">ğŸ’¬ ì»¤ë®¤ë‹ˆí‹° ì±„íŒ…(ë°ëª¨)</div>
    <div class="chat-body" id="chatBody"></div>
    <div class="chat-input">
      <input id="chatInput" placeholder="ë©”ì‹œì§€ ì…ë ¥..." onkeypress="if(event.key==='Enter')sendChat()"/>
      <button onclick="sendChat()">ì „ì†¡</button>
    </div>
  </div>

  <div class="notice" id="notice"></div>

  <!-- Firebase SDKs (v10) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { 
      getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut 
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot,
      doc, setDoc, getDoc, updateDoc, increment, runTransaction
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
    import {
      getStorage, ref, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";

    // === ë„ˆê°€ ì¤€ firebaseConfig ê·¸ëŒ€ë¡œ ì ìš© ===
    const firebaseConfig = {
      apiKey: "AIzaSyBJZle3txhhthWgaIWTTHzrLl4bkJqQye4",
      authDomain: "fast-gateway-290809.firebaseapp.com",
      projectId: "fast-gateway-290809",
      storageBucket: "fast-gateway-290809.firebasestorage.app",
      messagingSenderId: "640433110514",
      appId: "1:640433110514:web:8fe4fafc9a987b6a4b3f6b",
      measurementId: "G-2V57XWX7CW"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // ======== UI Helpers ========
    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);
    function toast(msg){
      const n=$("#notice");
      n.textContent=msg; n.style.display="block";
      clearTimeout(window._toastT); window._toastT=setTimeout(()=>n.style.display="none",2200);
    }
    function now(){ return new Date().toLocaleString(); }
    function toggleTheme(){ const b=document.body; b.dataset.theme = b.dataset.theme==="dark"?"light":"dark"; }
    window.toggleTheme = toggleTheme;

    // ======== Router ========
    const router = {
      show(page){
        const feed=$("#pageFeed"), prof=$("#pageProfile");
        if(page==='profile'){ feed.style.display="none"; prof.style.display="grid"; renderProfile(); }
        else { feed.style.display="grid"; prof.style.display="none"; }
      }
    };
    window.router = router;

    // ======== Modals ========
    function openModal(name){
      closeModal();
      if(name==='login') $("#loginModal").style.display="flex";
      if(name==='signup') $("#signupModal").style.display="flex";
      if(name==='comment') $("#commentModal").style.display="flex";
    }
    function closeModal(){ $$(".modal").forEach(m=>m.style.display="none"); }
    window.openModal=openModal; window.closeModal=closeModal;

    // ======== Auth ========
    async function signup(){
      const email=$("#suEmail").value.trim();
      const pw=$("#suPw").value.trim();
      const nick=$("#suNick").value.trim();
      if(!email||!pw||!nick) return alert("ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸/ë‹‰ë„¤ì„ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
      const cred = await createUserWithEmailAndPassword(auth, email, pw);
      await setDoc(doc(db, "users", cred.user.uid), {
        email, nickname:nick, level:1, exp:0,
        postsCount:0, commentsCount:0, likesGiven:0, badges:[],
        photoURL: "", // í”„ë¡œí•„ ì´ë¯¸ì§€ URL
        createdAt: serverTimestamp()
      });
      toast("íšŒì›ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸ ìƒíƒœì…ë‹ˆë‹¤.");
      closeModal();
    }
    async function login(){
      const email=$("#loginEmail").value.trim();
      const pw=$("#loginPw").value.trim();
      await signInWithEmailAndPassword(auth, email, pw);
      toast("ë¡œê·¸ì¸ ì„±ê³µ!");
      closeModal();
    }
    async function logout(){
      await signOut(auth);
      toast("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }
    window.signup=signup; window.login=login; window.logout=logout;

    // ë¡œê·¸ì¸ ìƒíƒœ ë³€ê²½ ê°ì§€
    onAuthStateChanged(auth, async (user)=>{
      if(user){
        $("#authArea").style.display="none";
        $("#userArea").style.display="flex";
        const uref = doc(db, "users", user.uid);
        let us = await getDoc(uref);
        if(!us.exists()){
          await setDoc(uref, { email:user.email||"", nickname:"ì‚¬ìš©ì", level:1, exp:0,
            postsCount:0, commentsCount:0, likesGiven:0, badges:[], photoURL:"", createdAt: serverTimestamp() });
          us = await getDoc(uref);
        }
        const data = us.data();
        $("#chipNick").textContent = data.nickname || "ì‚¬ìš©ì";
        $("#chipLv").textContent = data.level || 1;
        setAvatarChip(data.photoURL);
        renderProfile();
        listenMyPosts();
      }else{
        $("#authArea").style.display="flex";
        $("#userArea").style.display="none";
        $("#myPosts").innerHTML="";
      }
    });

    // ======== XP / Level / Badges ========
    const XP_PER = { post:20, comment:8, like:2 };
    const LV_STEP = 100;

    async function addXp(uid, delta, counters={}){
      const uref = doc(db, "users", uid);
      await runTransaction(db, async (tx)=>{
        const snap = await tx.get(uref);
        if(!snap.exists()) return;
        const u = snap.data();
        const postsCount = (u.postsCount||0) + (counters.postsCount||0);
        const commentsCount = (u.commentsCount||0) + (counters.commentsCount||0);
        const likesGiven = (u.likesGiven||0) + (counters.likesGiven||0);

        let exp = (u.exp||0) + delta;
        let level = u.level||1;
        while(exp >= LV_STEP){ exp -= LV_STEP; level += 1; }

        const badges = new Set(u.badges||[]);
        if(postsCount >= 5) badges.add("âœï¸ ì‘ê°€");
        if(commentsCount >= 10) badges.add("ğŸ’¬ ì†Œí†µì™•");
        if(likesGiven >= 20) badges.add("â¤ï¸ íŒ¬ì‹¬");

        tx.update(uref, {
          exp, level, postsCount, commentsCount, likesGiven, badges: Array.from(badges)
        });
      });
    }

    // ======== Storage Helpers ========
    async function uploadImage(file, path){
      const storageRef = ref(storage, path);
      await uploadBytes(storageRef, file);
      return await getDownloadURL(storageRef);
    }

    // ë¯¸ë¦¬ë³´ê¸°: ê²Œì‹œê¸€ ì´ë¯¸ì§€
    $("#postImage").addEventListener("change", (e)=>{
      const f=e.target.files?.[0];
      const pv=$("#postImagePreview");
      if(!f){ pv.textContent=""; return; }
      pv.innerHTML = `ì„ íƒë¨: ${f.name} (${Math.round(f.size/1024)} KB)`;
    });

    // ======== Posts (ì‹¤ì‹œê°„) ========
    const postsDiv = $("#posts");
    let unsubscribePosts = null;

    function listenPosts(){
      if(unsubscribePosts) unsubscribePosts();
      const q = query(collection(db,"posts"), orderBy("createdAt","desc"));
      unsubscribePosts = onSnapshot(q, (snap)=>{
        postsDiv.innerHTML = "";
        snap.forEach(docSnap=>{
          const p = docSnap.data();
          const id = docSnap.id;
          postsDiv.appendChild(renderPost(id, p));
        });
      });
    }

    function renderPost(id, p){
      const wrap=document.createElement("div");
      wrap.className="post panel";
      const dateText = p.createdAt?.toDate ? p.createdAt.toDate().toLocaleString() : "(ë°©ê¸ˆ)";
      const imgHtml = p.imageUrl ? `<img class="post-image" src="${p.imageUrl}" alt="post image" loading="lazy" />` : "";
      wrap.innerHTML = `
        <div class="post-head">
          <div style="width:28px;height:28px;border-radius:50%;background:#c7c7d7"></div>
          <div><strong>${p.authorNick||"ìµëª…"}</strong> <span class="meta">Â· ${dateText}</span></div>
        </div>
        <div class="body" style="white-space:pre-wrap">${escapeHtml(p.text||"")}</div>
        ${imgHtml}
        <div class="actions">
          <button class="action" onclick="likePost('${id}')">ğŸ‘ ì¢‹ì•„ìš”</button>
          <button class="action" onclick="openCommentsModal('${id}')">ğŸ’¬ ëŒ“ê¸€</button>
          <button class="action" onclick="sharePost()">ğŸ”— ê³µìœ </button>
        </div>
        <div class="counts">ì¢‹ì•„ìš” <span>${p.likesCount||0}</span> Â· ëŒ“ê¸€ <span>${p.commentsCount||0}</span></div>
      `;
      return wrap;
    }

    async function addPost(){
      const user = auth.currentUser;
      if(!user) return alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.");
      const text = $("#composer").value.trim();
      const file = $("#postImage").files?.[0] || null;
      if(!text && !file) return alert("ë‚´ìš© ë˜ëŠ” ì´ë¯¸ì§€ë¥¼ ì…ë ¥/ì„ íƒí•˜ì„¸ìš”.");

      const uref = doc(db, "users", user.uid);
      const u = (await getDoc(uref)).data();

      let imageUrl = "";
      if(file){
        const ext = file.name.split('.').pop() || 'jpg';
        const ts = Date.now();
        const path = `posts/${user.uid}/${ts}.${ext}`;
        try{
          imageUrl = await uploadImage(file, path);
        }catch(e){
          console.error(e);
          toast("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨â€¦ í…ìŠ¤íŠ¸ë§Œ ê²Œì‹œí•©ë‹ˆë‹¤.");
        }
      }

      await addDoc(collection(db,"posts"), {
        uid: user.uid,
        authorNick: u.nickname || "ìµëª…",
        text: text || "",
        imageUrl,
        likesCount: 0,
        likedBy: [],
        commentsCount: 0,
        createdAt: serverTimestamp()
      });
      $("#composer").value="";
      $("#postImage").value="";
      $("#postImagePreview").textContent="";
      await addXp(user.uid, XP_PER.post, {postsCount:1});
      toast("ğŸ“ ê²Œì‹œê¸€ ë“±ë¡!");
    }
    window.addPost = addPost;

    async function likePost(postId){
      const user = auth.currentUser;
      if(!user) return alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.");
      const pref = doc(db, "posts", postId);
      await runTransaction(db, async (tx)=>{
        const ps = await tx.get(pref);
        if(!ps.exists()) return;
        const p = ps.data();
        const likedBy = new Set(p.likedBy||[]);
        if(likedBy.has(user.uid)){
          likedBy.delete(user.uid);
          tx.update(pref, { likedBy: Array.from(likedBy), likesCount: Math.max(0,(p.likesCount||0)-1) });
        }else{
          likedBy.add(user.uid);
          tx.update(pref, { likedBy: Array.from(likedBy), likesCount: (p.likesCount||0)+1 });
          await addXp(user.uid, XP_PER.like, {likesGiven:1});
        }
      });
    }
    window.likePost = likePost;

    // ======== Comments (ì‹¤ì‹œê°„) ========
    let commentTargetPostId = null;
    let unsubscribeComments = null;

    function openCommentsModal(postId){
      commentTargetPostId = postId;
      $("#commentList").innerHTML = "";
      openModal('comment');
      listenComments(postId);
    }
    window.openCommentsModal = openCommentsModal;

    function listenComments(postId){
      if(unsubscribeComments) unsubscribeComments();
      const q = query(collection(db,"posts",postId,"comments"), orderBy("createdAt","desc"));
      unsubscribeComments = onSnapshot(q, (snap)=>{
        const list=$("#commentList"); list.innerHTML="";
        snap.forEach(c=>{
          const d=c.data();
          const dateText = d.createdAt?.toDate ? d.createdAt.toDate().toLocaleString() : "(ë°©ê¸ˆ)";
          const item=document.createElement("div");
          item.style.padding="8px 0"; item.style.borderBottom="1px solid rgba(0,0,0,.06)";
          item.innerHTML = `<strong>${d.authorNick||"ìµëª…"}</strong> <span class="meta">Â· ${dateText}</span><div>${escapeHtml(d.text||"")}</div>`;
          list.appendChild(item);
        });
      });
    }

    async function addComment(){
      const user = auth.currentUser;
      if(!user) return alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.");
      const txt = $("#commentInput").value.trim();
      if(!txt) return;
      const u = (await getDoc(doc(db,"users",user.uid))).data();
      await addDoc(collection(db,"posts",commentTargetPostId,"comments"), {
        uid: user.uid,
        authorNick: u.nickname || "ìµëª…",
        text: txt,
        createdAt: serverTimestamp()
      });
      $("#commentInput").value="";
      await updateDoc(doc(db,"posts",commentTargetPostId), { commentsCount: increment(1) });
      await addXp(user.uid, XP_PER.comment, {commentsCount:1});
      toast("ğŸ’¬ ëŒ“ê¸€ ë“±ë¡!");
    }
    window.addComment = addComment;

    // ======== Profile ========
    async function renderProfile(){
      const user = auth.currentUser;
      if(!user){
        $("#profNick").textContent="-"; $("#profEmail").textContent="@"; $("#profLv").textContent="1";
        $("#xpFill").style.width="0%"; $("#xpText").textContent="0/100"; $("#badges").innerHTML="";
        $("#profAvatar").style.backgroundImage = "";
        setAvatarChip("");
        return;
      }
      const us = await getDoc(doc(db,"users",user.uid));
      const d = us.data();
      $("#profNick").textContent = d.nickname || "ì‚¬ìš©ì";
      $("#profEmail").textContent = user.email || "@";
      $("#profLv").textContent = d.level || 1;
      $("#chipLv").textContent = d.level || 1;
      $("#chipNick").textContent = d.nickname || "ì‚¬ìš©ì";
      const pct = Math.round(((d.exp||0)/LV_STEP)*100);
      $("#xpFill").style.width = pct+"%";
      $("#xpText").textContent = `${d.exp||0}/${LV_STEP}`;
      $("#badges").innerHTML = (d.badges||[]).map(b=>`<span class="badge-tile">${b}</span>`).join("") || `<span class="meta">íšë“í•œ ë±ƒì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</span>`;
      $("#profAvatar").style.backgroundImage = d.photoURL ? `url('${d.photoURL}')` : "";
      setAvatarChip(d.photoURL || "");
    }

    function setAvatarChip(url){
      const el = $("#chipAvatar");
      el.style.backgroundImage = url ? `url('${url}')` : "";
    }

    async function uploadAvatar(){
      const user = auth.currentUser;
      if(!user) return alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.");
      const file = $("#avatarInput").files?.[0];
      if(!file) return alert("ì—…ë¡œë“œí•  ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
      try{
        const ext = file.name.split('.').pop() || 'jpg';
        const path = `users/${user.uid}/avatar.${ext}`;
        const url = await uploadImage(file, path);
        await updateDoc(doc(db,"users",user.uid), { photoURL: url });
        $("#profAvatar").style.backgroundImage = `url('${url}')`;
        setAvatarChip(url);
        toast("í”„ë¡œí•„ ì‚¬ì§„ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
      }catch(e){
        console.error(e);
        alert("í”„ë¡œí•„ ì‚¬ì§„ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      }
    }
    window.uploadAvatar = uploadAvatar;

    function listenMyPosts(){
      const user = auth.currentUser; if(!user) return;
      const q = query(collection(db,"posts"), orderBy("createdAt","desc"));
      onSnapshot(q, (snap)=>{
        const my=$("#myPosts"); my.innerHTML="";
        snap.forEach(s=>{
          const p=s.data();
          if(p.uid===user.uid){
            const dateText = p.createdAt?.toDate ? p.createdAt.toDate().toLocaleString() : "(ë°©ê¸ˆ)";
            const img = p.imageUrl ? `<img class="post-image" src="${p.imageUrl}" alt="my post image" loading="lazy" />` : "";
            const item=document.createElement("div");
            item.className="post panel";
            item.innerHTML = `<div class="meta">${dateText}</div><div style="white-space:pre-wrap">${escapeHtml(p.text||"")}</div>${img}`;
            my.appendChild(item);
          }
        });
      });
    }

    // ======== Misc ========
    function sharePost(){
      navigator.clipboard?.writeText(location.href).catch(()=>{});
      toast("ğŸ”— ë§í¬ ë³µì‚¬!");
    }
    window.sharePost = sharePost;

    function toggleChat(){ $("#chat").classList.toggle("open"); }
    function sendChat(){
      const input=$("#chatInput"); const msg=input.value.trim(); if(!msg) return;
      const user = auth.currentUser;
      const nick = $("#chipNick").textContent || "ìµëª…";
      const b=$("#chatBody");
      const mine=document.createElement("div");
      mine.innerHTML=`<div><strong>${user?nick:"ìµëª…"}</strong> <span class="meta">Â· ${now()}</span></div><div>${escapeHtml(msg)}</div>`;
      mine.style.margin="8px 0"; mine.style.padding="6px 8px"; mine.style.border="1px solid rgba(0,0,0,.06)"; mine.style.borderRadius="10px";
      b.appendChild(mine); input.value=""; b.scrollTop=b.scrollHeight;
    }
    window.toggleChat=toggleChat; window.sendChat=sendChat;

    function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    // ======== Init ========
    listenPosts(); // í”¼ë“œ ì‹¤ì‹œê°„
    router.show('feed'); // ê¸°ë³¸ í˜ì´ì§€
    // ======== Admin Like Control ========
    function setupAdminTools() {
      onAuthStateChanged(auth, async (user) => {
        // ê´€ë¦¬ì ê³„ì • ì´ë©”ì¼ í™•ì¸
        if (user && user.email === "donish351@gmail.com") {
          // í”Œë¡œíŒ… ë²„íŠ¼ ìƒì„±
          if (!document.getElementById("adminLikeBtn")) {
            const btn = document.createElement("button");
            btn.id = "adminLikeBtn";
            btn.textContent = "â˜…";
            btn.style.cssText = `
              position:fixed; right:20px; bottom:20px; z-index:100;
              background:#ff4757; color:#fff; border:none; border-radius:50%;
              width:50px; height:50px; font-size:20px; cursor:pointer;
              box-shadow:0 4px 10px rgba(0,0,0,.3);
            `;
            btn.onclick = openAdminLikeModal;
            document.body.appendChild(btn);

            // ëª¨ë‹¬ HTML ìƒì„±
            const modal = document.createElement("div");
            modal.id = "adminLikeModal";
            modal.className = "modal";
            modal.innerHTML = `
              <div class="panel card">
                <h3 style="margin-top:0">ì¢‹ì•„ìš” ìˆ˜ì •</h3>
                <select id="postSelect" style="width:100%;margin-bottom:10px"></select>
                <input id="likeInput" type="number" min="0" placeholder="ì¢‹ì•„ìš” ìˆ˜" />
                <div style="display:flex;gap:8px;margin-top:10px;justify-content:flex-end">
                  <button class="btn primary" onclick="applyLikeChange()">ì €ì¥</button>
                  <button class="btn ghost" onclick="closeAdminLikeModal()">ë‹«ê¸°</button>
                </div>
              </div>
            `;
            document.body.appendChild(modal);
          }
        }
      });
    }

    function openAdminLikeModal() {
      const modal = document.getElementById("adminLikeModal");
      const select = document.getElementById("postSelect");
      select.innerHTML = "";

      // Firestoreì—ì„œ ê²Œì‹œê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
      const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
      onSnapshot(q, (snap) => {
        select.innerHTML = "";
        snap.forEach((docSnap) => {
          const p = docSnap.data();
          const option = document.createElement("option");
          option.value = docSnap.id;
          option.textContent = (p.text || "(ì´ë¯¸ì§€)") + ` â€” ğŸ‘ ${p.likesCount || 0}`;
          select.appendChild(option);
        });
      });

      modal.style.display = "flex";
    }

    function closeAdminLikeModal() {
      document.getElementById("adminLikeModal").style.display = "none";
    }

    async function applyLikeChange() {
      const postId = document.getElementById("postSelect").value;
      const newLikes = parseInt(document.getElementById("likeInput").value, 10);
      if (!postId || isNaN(newLikes)) {
        alert("ê²Œì‹œê¸€ê³¼ ì¢‹ì•„ìš” ìˆ˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        return;
      }
      const pref = doc(db, "posts", postId);
      await updateDoc(pref, { likesCount: newLikes });
      toast("ğŸ‘ ì¢‹ì•„ìš” ìˆ˜ì • ì™„ë£Œ!");
      closeAdminLikeModal();
    }

    // ì‹¤í–‰
    setupAdminTools();
    // ê¸°ì¡´ ì½”ë“œ ì‹¤í–‰ ë¶€ë¶„
setupAdminTools();

// ğŸ‘‡ ìƒˆë¡œ ì¶”ê°€
window.openAdminLikeModal = openAdminLikeModal;
window.closeAdminLikeModal = closeAdminLikeModal;
window.applyLikeChange = applyLikeChange;
  </script>
  
  <script type="module">
    // === ì¸ê¸°ê¸€ í˜ì´ì§€ ===
    const pageHot = document.createElement("div");
    pageHot.className = "layout";
    pageHot.id = "pageHot";
    pageHot.style.display = "none";
    pageHot.innerHTML = `
      <aside class="panel">
        <ul style="list-style:none;padding:0;margin:0">
          <li style="padding:8px 0;cursor:pointer" onclick="router.show('feed')">â¬… í”¼ë“œë¡œ ëŒì•„ê°€ê¸°</li>
        </ul>
      </aside>
      <main>
        <div class="panel">
          <h3 style="margin-top:0">ğŸ”¥ ì¸ê¸°ê¸€</h3>
          <div id="hotPosts"></div>
        </div>
      </main>
      <aside class="panel right"></aside>
    `;
    document.body.appendChild(pageHot);

    // ë¼ìš°í„° í™•ì¥
    const _origShow = router.show;
    router.show = function (page) {
      _origShow(page);
      if (page === "hot") {
        document.getElementById("pageFeed").style.display = "none";
        document.getElementById("pageProfile").style.display = "none";
        pageHot.style.display = "grid";
        listenHotPosts();
      } else {
        pageHot.style.display = "none";
      }
    };

    // ì¸ê¸°ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° (ì¢‹ì•„ìš” ìˆœ)
    let unsubscribeHot = null;
    function listenHotPosts() {
      if (unsubscribeHot) unsubscribeHot();
      const q = query(
  collection(db, "posts"),
  orderBy("createdAt", "desc")
);
      unsubscribeHot = onSnapshot(q, (snap) => {
        const hotDiv = document.getElementById("hotPosts");
        hotDiv.innerHTML = "";
        snap.forEach((docSnap) => {
          const p = docSnap.data();
          hotDiv.appendChild(renderPost(docSnap.id, p));
        });
      });
    }

    // ì „ì—­ ì—°ê²°
    window.listenHotPosts = listenHotPosts;
  </script>
  <!-- === ê²Œì‹œê¸€ í¬ê²Œ ë³´ê¸° íŒì—… (ì¢‹ì•„ìš”/ëŒ“ê¸€/ê³µìœ  í¬í•¨) === -->
<div id="viewModal" class="modal" style="display:none;">
  <div class="panel card" style="max-width:720px;width:92vw;">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
      <h3 style="margin:0">ê²Œì‹œê¸€</h3>
      <button class="btn ghost" id="viewCloseBtn">ë‹«ê¸°</button>
    </div>
    <div id="viewHead" class="post-head" style="margin-top:8px"></div>
    <div id="viewBody" class="body" style="white-space:pre-wrap"></div>
    <img id="viewImage" class="post-image" style="display:none" alt="post image (large)" />
    <div class="actions">
      <button class="action" id="viewLikeBtn">ğŸ‘ ì¢‹ì•„ìš”</button>
      <button class="action" id="viewShareBtn">ğŸ”— ê³µìœ </button>
    </div>
    <div class="counts">ì¢‹ì•„ìš” <span id="viewLikes">0</span> Â· ëŒ“ê¸€ <span id="viewCommentsCount">0</span></div>

    <h4 style="margin:12px 0 6px">ëŒ“ê¸€</h4>
    <div id="viewComments" style="max-height:260px;overflow:auto;border:1px solid rgba(0,0,0,.06);border-radius:10px;padding:8px"></div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <input id="viewCommentInput" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš” (ë¡œê·¸ì¸ í•„ìš”)" onkeypress="if(event.key==='Enter') submitViewComment()"/>
      <button class="btn primary" id="viewCommentBtn">ë“±ë¡</button>
    </div>
  </div>
</div>

<script type="module">
  // Firebase ì¬ì‚¬ìš© ì„í¬íŠ¸ (ê¸°ì¡´ ì•± ê·¸ëŒ€ë¡œ ê°€ì ¸ì˜¤ê¸°)
  import { getApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import {
    getFirestore, doc, getDoc, updateDoc, collection, addDoc,
    query, orderBy, onSnapshot, limit, increment, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
  import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

  const db = getFirestore(getApp());
  const auth = getAuth();

  // ìœ í‹¸ (ì´ ëª¨ë“ˆ ë…ë¦½ ì‚¬ìš©)
  const qs = s => document.querySelector(s);
  const escapeHtml = s => (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  // í”¼ë“œ ì¸ë±ìŠ¤: í™”ë©´ì— ë³´ì´ëŠ” ì¹´ë“œì™€ ì‹¤ì œ Firestore ë¬¸ì„œë¥¼ ì—°ê²°
  // key = authorNick|text|imageUrl
  const indexMap = new Map(); // key -> [{id, p}, ... (ìµœì‹  ìš°ì„ )]
  function makeKey(p){
    return `${p.authorNick||''}|${p.text||''}|${p.imageUrl||''}`;
  }
  function rebuildIndex(){
    const qy = query(collection(db,"posts"), orderBy("createdAt","desc"), limit(200));
    onSnapshot(qy, (snap)=>{
      indexMap.clear();
      snap.forEach(d=>{
        const p=d.data();
        const k=makeKey(p);
        const arr=indexMap.get(k)||[];
        arr.push({id:d.id, p});
        indexMap.set(k, arr);
      });
    });
  }
  rebuildIndex();

  // íŒì—… ì—˜ë¦¬ë¨¼íŠ¸
  const modal = qs("#viewModal");
  const viewHead = qs("#viewHead");
  const viewBody = qs("#viewBody");
  const viewImg  = qs("#viewImage");
  const viewLikes = qs("#viewLikes");
  const viewCommentsCount = qs("#viewCommentsCount");
  const viewComments = qs("#viewComments");
  const viewCommentInput = qs("#viewCommentInput");
  const viewCloseBtn = qs("#viewCloseBtn");
  const viewLikeBtn = qs("#viewLikeBtn");
  const viewShareBtn = qs("#viewShareBtn");
  const viewCommentBtn = qs("#viewCommentBtn");

  // ìƒíƒœ/êµ¬ë…
  let currentPostId = null;
  let unsubPostDoc = null;
  let unsubComments = null;

  function openView(){
    modal.style.display = "flex";
  }
  function closeView(){
    modal.style.display = "none";
    if (unsubPostDoc) { unsubPostDoc(); unsubPostDoc=null; }
    if (unsubComments) { unsubComments(); unsubComments=null; }
    currentPostId = null;
    viewComments.innerHTML = "";
  }
  viewCloseBtn.addEventListener("click", closeView);
  document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeView(); });

  // í”¼ë“œì—ì„œ ì¹´ë“œ í´ë¦­ â†’ íŒì—… ì˜¤í”ˆ (ë²„íŠ¼ ì˜ì—­ì€ ì œì™¸)
  const postsRoot = document.getElementById("posts");
  const shouldIgnore = (el) => !!(el.closest(".actions") || el.closest(".action") || el.closest("button") || el.closest("a"));

  postsRoot?.addEventListener("click", (e)=>{
    const card = e.target.closest(".post");
    if(!card || shouldIgnore(e.target)) return;

    const author = card.querySelector(".post-head strong")?.textContent?.trim() || "ìµëª…";
    const text = card.querySelector(".body")?.textContent || "";
    const img = card.querySelector("img.post-image")?.src || "";

    const k = `${author}|${text}|${img}`;
    const arr = indexMap.get(k);
    if(!arr || !arr.length){ alert("ê²Œì‹œê¸€ì„ ì°¾ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆì–´ìš”."); return; }

    const { id, p } = arr[0]; // ìµœì‹  ê¸€ ìš°ì„ 
    currentPostId = id;
    renderView(p);
    wireLiveUpdates(id);
    openView();
  });

  // ë³´ê¸° í™”ë©´ ë Œë”
  function renderView(p){
    const dateText = p.createdAt?.toDate ? p.createdAt.toDate().toLocaleString() : "(ë°©ê¸ˆ)";
    viewHead.innerHTML = `
      <div style="width:28px;height:28px;border-radius:50%;background:#c7c7d7"></div>
      <div><strong>${escapeHtml(p.authorNick||"ìµëª…")}</strong> <span class="meta">Â· ${dateText}</span></div>
    `;
    viewBody.textContent = p.text || "";
    if(p.imageUrl){
      viewImg.src = p.imageUrl;
      viewImg.style.display = "block";
    }else{
      viewImg.style.display = "none";
    }
    viewLikes.textContent = p.likesCount || 0;
  }

  // ì‹¤ì‹œê°„ êµ¬ë… (í•´ë‹¹ ê¸€/ëŒ“ê¸€)
  function wireLiveUpdates(postId){
    if (unsubPostDoc) unsubPostDoc();
    if (unsubComments) unsubComments();

    unsubPostDoc = onSnapshot(doc(db,"posts",postId),(snap)=>{
      if(snap.exists()) renderView(snap.data());
    });

    const cq = query(collection(db,"posts",postId,"comments"), orderBy("createdAt","desc"));
    unsubComments = onSnapshot(cq, async (snap)=>{
      viewComments.innerHTML="";
      let cnt = 0;
      for (const c of snap.docs) {
        const d = c.data(); cnt++;
        const dateText = d.createdAt?.toDate ? d.createdAt.toDate().toLocaleString() : "(ë°©ê¸ˆ)";

        // ğŸ”¹ ëŒ“ê¸€ ì‘ì„±ì í”„ë¡œí•„ ê°€ì ¸ì˜¤ê¸°
        let photo = "";
        if(d.uid){
          try{
            const usnap = await getDoc(doc(db,"users",d.uid));
            if(usnap.exists()) photo = usnap.data().photoURL || "";
          }catch(e){
            console.warn("ëŒ“ê¸€ í”„ë¡œí•„ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜", e);
          }
        }

        // ğŸ”¹ ëŒ“ê¸€ DOM
        const item = document.createElement("div");
        item.style.display="flex";
        item.style.gap="8px";
        item.style.padding="6px 0";
        item.style.borderBottom="1px solid rgba(0,0,0,.06)";

        const avatar = document.createElement("div");
        avatar.style.width="28px";
        avatar.style.height="28px";
        avatar.style.borderRadius="50%";
        avatar.style.background="#c7c7d7";
        avatar.style.flexShrink="0";
        if(photo){
          avatar.style.backgroundImage=`url(${photo})`;
          avatar.style.backgroundSize="cover";
          avatar.style.backgroundPosition="center";
        }

        const body = document.createElement("div");
        body.innerHTML = `
          <strong>${escapeHtml(d.authorNick||"ìµëª…")}</strong> 
          <span class="meta">Â· ${dateText}</span>
          <div>${escapeHtml(d.text||"")}</div>
        `;

        item.appendChild(avatar);
        item.appendChild(body);
        viewComments.appendChild(item);
      }
      viewCommentsCount.textContent = cnt;
    });
  }

  // ì¢‹ì•„ìš”(ê¸°ì¡´ ì „ì—­ likePost ìˆìœ¼ë©´ ì¬ì‚¬ìš©)
  async function likeCurrent(){
    if(!currentPostId) return;
    if (window.likePost) { window.likePost(currentPostId); return; }
    // í´ë°± (ê±°ì˜ ì•ˆíƒˆ ê²½ë¡œ)
    const user = auth.currentUser;
    if(!user) return alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.");
    const pref = doc(db,"posts",currentPostId);
    const snap = await getDoc(pref);
    if(!snap.exists()) return;
    const p = snap.data();
    const likedBy = new Set(p.likedBy||[]);
    if(likedBy.has(user.uid)){
      likedBy.delete(user.uid);
      await updateDoc(pref, { likedBy:Array.from(likedBy), likesCount:Math.max(0,(p.likesCount||0)-1) });
    }else{
      likedBy.add(user.uid);
      await updateDoc(pref, { likedBy:Array.from(likedBy), likesCount:(p.likesCount||0)+1 });
    }
  }
  viewLikeBtn.addEventListener("click", likeCurrent);

  // ê³µìœ 
  viewShareBtn.addEventListener("click", ()=>{
    if(!currentPostId) return;
    const url = `${location.origin}${location.pathname}#post-${currentPostId}`;
    navigator.clipboard?.writeText(url).then(()=>alert("ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"));
  });

  // ëŒ“ê¸€ ë“±ë¡
  async function submitViewComment(){
    if(!currentPostId) return;
    const user = auth.currentUser;
    if(!user) return alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.");
    const text = viewCommentInput.value.trim(); if(!text) return;

    const us = await getDoc(doc(db,"users",user.uid));
    const nick = us.exists() ? (us.data().nickname || "ìµëª…") : "ìµëª…";

    await addDoc(collection(db,"posts",currentPostId,"comments"), {
      uid: user.uid, authorNick: nick, text, createdAt: serverTimestamp()
    });
    // ì™¸í˜• ì¹´ìš´íŠ¸ë„ ì¦‰ì‹œ ë°˜ì˜
    await updateDoc(doc(db,"posts",currentPostId), { commentsCount: increment(1) });
    viewCommentInput.value = "";
  }
  window.submitViewComment = submitViewComment;
  viewCommentBtn.addEventListener("click", submitViewComment);

  // UX: ì¹´ë“œì— ì»¤ì„œ ëª¨ì–‘ ì£¼ê¸°
  const style = document.createElement("style");
  style.textContent = `.post{cursor:pointer}`;
  document.head.appendChild(style);
</script>
<!-- === [IP 1íšŒ ê°€ì… ì œí•œ ìŠ¤ë‹ˆí«] body ë‹«ê¸° ì§ì „ì— ì¶”ê°€ === -->
<script type="module">
  import { getApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { 
    getFirestore, doc, getDoc, setDoc, runTransaction, serverTimestamp, deleteDoc 
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  const db = getFirestore(getApp());
  const auth = getAuth();

  // ---------- UI: ì´ë¯¸ ê°€ì…ëœ IP ì•ˆë‚´ ëª¨ë‹¬ ----------
  function ensureIpGuardUi(){
    if(document.getElementById("ipGuardModal")) return;
    const m = document.createElement("div");
    m.id = "ipGuardModal";
    m.className = "modal";
    m.innerHTML = `
      <div class="panel card">
        <h3 style="margin-top:0">ê°€ì… ì œí•œ</h3>
        <div id="ipGuardMsg" class="meta" style="line-height:1.6"></div>
        <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
          <button class="btn primary" id="ipGuardCloseBtn">í™•ì¸</button>
        </div>
      </div>
    `;
    document.body.appendChild(m);
    document.getElementById("ipGuardCloseBtn").onclick = ()=> m.style.display="none";
  }
  function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function showIpAlreadyModal(ip, data){
    ensureIpGuardUi();
    const msg = document.getElementById("ipGuardMsg");
    const uid = data?.uid || "-";
    const email = data?.email ? escapeHtml(data.email) : "";
    msg.innerHTML = `
      í•´ë‹¹ IP <strong>${escapeHtml(ip)}</strong>ì—ì„œëŠ” ì´ë¯¸ í•œ ë²ˆ ê°€ì…í•œ ê³„ì •ì´ ìˆìŠµë‹ˆë‹¤.<br/>
      ê³„ì • ID(UID): <code>${escapeHtml(uid)}</code>${email ? `<br/>ì´ë©”ì¼: <code>${email}</code>`:""}
    `;
    document.getElementById("ipGuardModal").style.display = "flex";
  }

  // ---------- ê³µìš©: IP ì¡°íšŒ(ê³µìš© ì„œë¹„ìŠ¤ ipify ì‚¬ìš©) ----------
  async function getPublicIP(){
    try{
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), 3500);
      const r = await fetch("https://api.ipify.org?format=json", { signal: ctrl.signal });
      clearTimeout(t);
      if(!r.ok) throw new Error("ip fetch failed");
      const { ip } = await r.json();
      return ip || null;
    }catch(e){
      console.warn("IP ì¡°íšŒ ì‹¤íŒ¨:", e);
      return null;
    }
  }
  function ipKeyFrom(ip){
    // Firestore ë¬¸ì„œ í‚¤ë¡œ ì‚¬ìš© ê°€ëŠ¥í•˜ë„ë¡ ì •ê·œí™”(IPv4/IPv6 ëª¨ë‘ ì•ˆì „)
    return (ip||"").replace(/[^a-zA-Z0-9]/g, "_");
  }

  // ---------- ì› signup ëŒ€ì²´ (IP 1íšŒ ì œí•œ í¬í•¨) ----------
  const _origSignup = window.signup; // í˜¹ì‹œ í•„ìš” ì‹œ ë³µêµ¬ìš©
  window.signup = async function enhancedSignupByIP(){
    // ê¸°ì¡´ ëª¨ë‹¬ ì…ë ¥ê°’ ê·¸ëŒ€ë¡œ ì‚¬ìš©
    const email = (document.getElementById("suEmail")?.value||"").trim();
    const pw    = (document.getElementById("suPw")?.value||"").trim();
    const nick  = (document.getElementById("suNick")?.value||"").trim();
    if(!email || !pw || !nick){
      alert("ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸/ë‹‰ë„¤ì„ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.");
      return;
    }

    // 1) IP ì¡°íšŒ
    const ip = await getPublicIP();
    const ipKey = ipKeyFrom(ip);
    const ipRef = ip ? doc(db, "ip_signups", ipKey) : null;

    // 2) ê¸°ì¡´ ê°€ì… ì—¬ë¶€ í™•ì¸ + ì˜ˆì•½(ê²½ìŸ ë°©ì§€)
    if(ipRef){
      // ì´ë¯¸ ë§¤í•‘ëœ ê³„ì •ì´ ìˆìœ¼ë©´ ì¦‰ì‹œ ì°¨ë‹¨ & ì•ˆë‚´
      const exist = await getDoc(ipRef);
      if(exist.exists() && exist.data()?.uid){
        showIpAlreadyModal(ip, exist.data());
        return;
      }
      // íŠ¸ëœì­ì…˜ìœ¼ë¡œ "ì˜ˆì•½" ë¬¸ì„œ ì„ ì (ë™ì‹œ ê°€ì… ë°©ì§€)
      try{
        await runTransaction(db, async (tx)=>{
          const snap = await tx.get(ipRef);
          if(snap.exists()){ // ëˆ„êµ°ê°€ ì„ ì í–ˆê±°ë‚˜ ì´ì „ ê°€ì… í”ì 
            throw { code:"ip-in-use", data:snap.data() };
          }
          tx.set(ipRef, { status:"reserved", reservedAt: serverTimestamp() });
        });
      }catch(err){
        const d = err?.data || (await getDoc(ipRef)).data() || {};
        showIpAlreadyModal(ip, d);
        return;
      }
    }

    // 3) ì‹¤ì œ íšŒì›ê°€ì… ì§„í–‰
    let cred = null;
    try{
      cred = await createUserWithEmailAndPassword(auth, email, pw);
      // users ì»¬ë ‰ì…˜ì— í”„ë¡œí•„ ë¬¸ì„œ ìƒì„± (ì›ì½”ë“œì™€ ë™ì¼ ìŠ¤í‚¤ë§ˆ)
      await setDoc(doc(db, "users", cred.user.uid), {
        email, nickname:nick, level:1, exp:0,
        postsCount:0, commentsCount:0, likesGiven:0, badges:[],
        photoURL:"", createdAt: serverTimestamp()
      });

      // 4) IP â†” ê³„ì • ë§¤í•‘ í™•ì • (ì˜ˆì•½ â†’ í™•ì •)
      if(ipRef){
        await setDoc(ipRef, {
          uid: cred.user.uid,
          email: email,
          ip: ip || null,
          createdAt: serverTimestamp()
        }, { merge:true });
      }

      alert("íšŒì›ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸ ìƒíƒœì…ë‹ˆë‹¤.");
      window.closeModal && window.closeModal(); // ë¡œê·¸ì¸ ëª¨ë‹¬ ë‹«ê¸°
    }catch(err){
      console.error(err);
      // ì‹¤íŒ¨ ì‹œ ì˜ˆì•½ ë¡¤ë°±(ë‹¤ìŒ ê°€ì… ì‹œë„ ê°€ëŠ¥í•˜ê²Œ)
      if(ipRef){
        try{ await deleteDoc(ipRef); }catch(_){}
      }
      alert("íšŒì›ê°€ì… ì‹¤íŒ¨: " + (err?.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
    }
  };
</script>
<!-- === /IP 1íšŒ ê°€ì… ì œí•œ ìŠ¤ë‹ˆí« ë === -->
</body>
</html>